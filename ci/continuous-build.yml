resources:
  - repo: self

name: $(Version)$(Rev:.r)

trigger:
  batch: true
  branches:
    include:
      - "master"

pr:
  autoCancel: true
  branches:
    include:
      - "master"

jobs:
  - job: Extension
    pool:
      vmImage: macOS 10.13
      demands:
        - npm
        - node.js

    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: "8.12.0"

      - task: Npm@1
        displayName: "npm install"
        inputs:
          verbose: false

      - task: Gulp@0
        displayName: 'gulp build'
        inputs:
          targets: build

      - task: Gulp@0
        displayName: 'gulp test'
        inputs:
          targets: test
          arguments: '--testResults=TESTRESULTS.xml'

      - script: node ./node_modules/tfx-cli/_build/tfx-cli.js extension create --manifest-globs vss-extension.json
        displayName: 'Package Extension'

      - task: CopyFiles@2
        displayName: "Copy Files to staging"
        inputs:
          Contents: "**/*.vsix"
          TargetFolder: "$(Build.ArtifactStagingDirectory)"

      - task: PublishTestResults@2
        displayName: 'Publish Test Results **/TESTRESULTS.xml'
        inputs:
          testResultsFiles: '**/TESTRESULTS.xml'
        condition: succeededOrFailed()
      
      - task: PublishBuildArtifacts@1
        displayName: "Publish build artifacts"

  - job: Package
    dependsOn: BuildAndTest
    pool:
      vmImage: macOS 10.13
      demands:
        - npm
        - node.js
